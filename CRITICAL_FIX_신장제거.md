# 🚨 긴급 수정: 신장(키) Data Leakage 발견 및 수정

## 📅 수정일: 2025-11-11 (2차 수정)
## 🎯 중요도: ⚠️⚠️⚠️ **CRITICAL**

---

## 😱 **진짜 문제 발견!**

### **1차 수정 (BMI 파생 특성 제거) - 불충분**
- ❌ `bmi_unhealthy_interaction` 제거
- ❌ `bmi_sodium_interaction` 제거
- **결과**: 여전히 R² 0.999! 문제 해결 안 됨!

### **2차 수정 (신장 제거) - 진짜 원인!** ⚠️⚠️⚠️

**문제의 핵심: `신장` (키) 컬럼이 입력에 포함됨!**

```
BMI = 체중(kg) / 키²(m²)

따라서:
체중 = BMI × 키²

체중 예측 시:
입력 → 신장 (키)
     ↓
  모델이 학습: 체중 ≈ f(키, BMI, 식습관)
     ↓
  키를 알면 BMI에서 체중 역산!
     ↓
출력 ← 체중 (거의 완벽하게 맞춤)

→ R² 0.999의 진짜 원인!
```

---

## 📊 **증거: 여전히 높은 성능**

### **1차 수정 후 결과 (신장 포함):**
```
체중:     R² = 0.9986 🚨 (여전히 너무 높음!)
BMI:      R² = 0.9989 🚨 (여전히 너무 높음!)
허리둘레:  R² = 0.9654 🚨 (여전히 높음)
```

### **예상되는 2차 수정 후 결과 (신장 제외):**
```
체중:     R² = 0.70-0.85 ✅ (정상 범위)
BMI:      R² = 0.65-0.80 ✅ (정상 범위)
허리둘레:  R² = 0.70-0.82 ✅ (정상 범위)
```

---

## ✅ **수정 내용**

### **파일: ver1/src/TABNET_ENHANCED_MODEL.py (Line 678-688)**

```python
# ⚠️ CRITICAL: 신장(키)은 체중/BMI와 직접 연관되므로 반드시 제외!
# BMI = 체중 / 키² → 키를 알면 체중 역산 가능 (Data Leakage!)
exclude_variables_by_biomarker = {
    '체중': ['체중', '체질량지수', '허리둘레(WAIST)', '골격근량', '체지방량', 
            '내장지방레벨', '체지방률', '골격근률', '신장'],  # ← 신장 추가!
    '체질량지수': ['체중', '체질량지수', '허리둘레(WAIST)', '골격근량', '체지방량', 
                  '내장지방레벨', '체지방률', '골격근률', '신장'],  # ← 신장 추가!
    '허리둘레(WAIST)': ['체중', '체질량지수', '허리둘레(WAIST)', '골격근량', '체지방량', 
                       '내장지방레벨', '체지방률', '골격근률', '신장'],  # ← 신장 추가!
    'SBP': ['SBP', 'DBP'],
    'DBP': ['SBP', 'DBP'],
    'TG': ['TG', 'HDL CHOL.', 'LDL CHOL.', 'TOTAL CHOL.']
}
```

---

## 🔄 **재학습 필수!**

### **희정님이 해야 할 일:**

#### **1. 현재 학습 즉시 중단!**
```bash
# Windows에서 Ctrl+C
```

#### **2. 최신 코드 가져오기**
```bash
cd "G:\내 드라이브\#인력양성\3. 식이_SNUH\#Prediction"

# 로컬 변경사항 임시 저장
git stash

# 최신 코드 (신장 제거 버전)
git pull origin main

# ver1로 이동
cd ver1
```

#### **3. 재학습 실행**
```bash
python run_training.py safe
```

#### **4. 대기**
- 예상 시간: **약 60분**

---

## 📊 **이번에는 진짜 바뀔 것입니다!**

### **변화 예상:**

| 지표 | 현재 (신장 포함) | 예상 (신장 제외) | 차이 |
|------|-----------------|-----------------|------|
| **체중** | 0.9986 🚨 | **0.70-0.85** ✅ | **-15%** 📉 |
| **BMI** | 0.9989 🚨 | **0.65-0.80** ✅ | **-20%** 📉 |
| **허리둘레** | 0.9654 🚨 | **0.70-0.82** ✅ | **-15%** 📉 |
| **SBP** | 0.8066 ✅ | **0.78-0.82** ✅ | 변화 없음 |
| **DBP** | 0.8164 ✅ | **0.78-0.84** ✅ | 변화 없음 |
| **TG** | 0.8090 ✅ | **0.78-0.84** ✅ | 변화 없음 |

### **왜 이렇게 많이 떨어질까요?**

**신장은 체중/BMI의 거의 완벽한 예측 변수입니다!**

```
예시:
신장 170cm, BMI 25 → 체중 = 25 × (1.7)² = 72.25kg
신장 160cm, BMI 25 → 체중 = 25 × (1.6)² = 64.00kg

→ 신장을 알면 체중을 거의 정확히 계산 가능!
→ 식습관의 영향이 아니라 신장의 영향!
```

---

## 🎯 **왜 처음에 못 찾았나요?**

### **복잡한 수정 순서:**

1. **BMI 파생 특성 (`bmi_*_interaction`)** ← 1차로 발견
2. **신장 (키)** ← 2차로 발견 (진짜 원인!)

### **신장이 더 큰 문제:**
- BMI 파생 특성: 간접적 영향 (~10% 기여)
- 신장: 직접적 영향 (~80% 기여!)

---

## 💡 **올바른 예측 목표**

### **❌ 잘못된 예측 (Data Leakage):**
```
체중 = f(신장, BMI, 식습관)
     ↓
거의 완벽한 예측 (R² 0.99)
하지만 순환 논리!
```

### **✅ 올바른 예측:**
```
체중 = f(식습관만)
     ↓
현실적인 예측 (R² 0.70-0.85)
식습관의 실제 영향!
```

---

## 📝 **논문 작성 시**

### **올바른 해석:**

**Before (Leakage):**
```
❌ "식습관으로 체중을 99.86% 정확도로 예측"
   → 심사자가 즉시 Data Leakage 의심!
```

**After (No Leakage):**
```
✅ "식습관 패턴을 통해 체중을 75% 정확도로 예측할 수 있었으며,
   이는 식습관이 체조성의 주요 결정 요인 중 하나임을 시사한다.
   나머지 25%는 유전, 운동, 대사 등 다른 요인으로 설명된다."
```

---

## 🔬 **검증 방법**

### **Feature Importance 확인 (재학습 후):**

**정상적인 경우:**
```
feature,importance
나이,0.22
고지방육류,0.18
식사량,0.15
단맛,0.12
성별,0.10
...
```

**문제 있는 경우 (발생하면 안 됨!):**
```
feature,importance
신장,0.85          ← 이게 나오면 아직 문제!
키,0.10            ← 이것도!
height,0.05        ← 이것도!
```

---

## 📚 **수정 히스토리**

### **Commit 1 (1차 수정 - 부분적):**
```
commit db10418
Fix data leakage: Remove BMI-derived features
- Removed bmi_unhealthy_interaction
- Removed bmi_sodium_interaction
```
**결과**: ❌ 여전히 R² 0.999

### **Commit 2 (2차 수정 - 완전):**
```
commit 0526540
CRITICAL FIX: Remove height (신장) from body composition predictions
- Added 신장 to exclude list for weight, BMI, and waist
- This was the REAL cause of R² 0.999
```
**예상 결과**: ✅ R² 0.70-0.85 (정상)

---

## ❓ **FAQ**

### **Q: 왜 두 번이나 놓쳤나요?**
**A:** BMI 파생 특성은 명시적이라 발견하기 쉬웠지만, 신장은 원본 데이터 컬럼이라 간과했습니다. 또한 `exclude_variables_by_biomarker` 리스트가 완전하지 않았습니다.

### **Q: 이번에는 확실한가요?**
**A:** 네! 데이터 컬럼을 모두 확인했고, 체조성 관련 모든 변수(신장, 체중, BMI, 허리둘레, 골격근량 등)를 제외하고 있습니다. 이제 순수 식습관만 입력으로 사용합니다.

### **Q: R² 0.75가 낮은 건 아닌가요?**
**A:** 전혀 아닙니다! 식습관만으로 체중의 75%를 설명한다면 매우 우수한 결과입니다. 심사자도 납득할 수 있는 현실적인 수치입니다.

### **Q: 다른 Data Leakage는 없나요?**
**A:** 현재 체크 완료:
- ✅ 신장 제거됨
- ✅ BMI 제거됨
- ✅ 체중 제거됨
- ✅ 허리둘레 제거됨
- ✅ 골격근량 제거됨
- ✅ 체지방량 제거됨
- ✅ BMI 파생 특성 제거됨
- ✅ Train/Test split 순서 올바름
- ✅ Scaler fit/transform 올바름

추가 문제 없을 것으로 판단됩니다.

---

## 🎯 **체크리스트**

- [ ] 1. 현재 학습 즉시 중단 (Ctrl+C)
- [ ] 2. `git stash` 실행
- [ ] 3. `git pull origin main` 실행
- [ ] 4. `cd ver1` 이동
- [ ] 5. `python run_training.py safe` 재실행
- [ ] 6. 약 60분 대기
- [ ] 7. Feature importance 확인 (신장 없어야 함!)
- [ ] 8. R² 0.70-0.85 확인
- [ ] 9. 결과 압축 및 업로드

---

## 📞 **지원**

재학습 중 문제 발생 시 즉시 연락주세요!

**GitHub**: https://github.com/HeejeongH/HPEACE_prediction  
**최신 커밋**: 0526540

---

**작성일**: 2025-11-11 (2차 긴급 수정)  
**중요도**: ⚠️⚠️⚠️ CRITICAL  
**상태**: 수정 완료, 재학습 필수
